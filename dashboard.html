<!DOCTYPE html>
<html lang="rw">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard â€” Les NGANYIRA</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .card{background:#fff;border:1px solid #eef1f7;border-radius:14px;padding:14px}
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .lbl{font-size:12px;color:#6b7280}
    .kpi .val{font-size:22px;font-weight:800}
    table.simple{width:100%;border-collapse:collapse}
    table.simple th,table.simple td{padding:8px;border-bottom:1px solid #eef1f7;text-align:left}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#eef3ff;color:#1f3fb3;font-weight:600}
    .btn{padding:8px 10px;border-radius:10px;background:var(--accent);color:#fff;border:0;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.secondary{background:#eef3ff;color:#1f3fb3}
    .btn.ghost{background:#fff;border:1px solid #d8deea;color:#1f2a4a}
    .muted{color:#6b7280}
    .danger{color:#b91c1c}
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-left">Les NGANYIRA</div>
    <nav class="nav-right">
      <a href="home.html">Ahabanza</a>
      <a href="about.html">Ibyerekeye</a>
      <a href="services.html">Serivisi</a>
      <a href="contribute.html">Tanga umusanzu</a>
      <a href="terms.html">Amategeko & Politiki</a>
      <button id="logoutBtn" class="nav-btn">Sohoka</button>
    </nav>
  </header>

  <main class="wrap">
    <h1>Dashboard</h1>
    <p class="pill">ðŸ”’ Tugaragaza **PAID + APPROVED gusa**</p>

    <!-- KPIs (PAID + APPROVED only) -->
    <div class="grid" id="kpis">
      <div class="card kpi">
        <div class="lbl">Ibyishuwe byemejwe (CAD)</div>
        <div class="val" id="kpiTotal">0.00</div>
      </div>
      <div class="card kpi">
        <div class="lbl">Umubare wâ€™inyandiko zemejwe</div>
        <div class="val" id="kpiCount">0</div>
      </div>
      <div class="card kpi">
        <div class="lbl">Fund yagezweho cyane</div>
        <div class="val" id="kpiTopFund">â€”</div>
      </div>
    </div>

    <!-- Per-fund subtotals -->
    <div class="card" style="margin-top:12px;">
      <h2>Subtotals kuri buri fund (PAID + APPROVED, CAD)</h2>
      <div class="grid" id="fundTotals"></div>
    </div>

    <!-- History (PAID + APPROVED only) -->
    <div class="card" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h2>Contribution history (PAID + APPROVED)</h2>
        <div>
          <button class="btn secondary" id="btnExport">Export CSV</button>
        </div>
      </div>
      <div id="historyBox" class="muted">â€”</div>
    </div>

    <!-- Admin approvals -->
    <div id="adminBox" class="card" style="margin-top:12px;display:none;">
      <h2>Pending approvals (PAID ariko ntibyemejwe)</h2>
      <div id="pendingBox" class="muted">â€”</div>
      <p class="muted" style="margin-top:8px;">ðŸ’¡ Uyu mwanya ugaragara kuri **admins** gusa.</p>
    </div>
  </main>

  <script>
    // ===== Auth =====
    const email = localStorage.getItem("lng_current_user");
    if (!email) { window.location.href = "index.html"; }
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("lng_current_user");
      window.location.href = "index.html";
    });

    // ===== Helpers =====
    function getContribs(){ try { return JSON.parse(localStorage.getItem("lng_contribs")||"{}"); } catch { return {}; } }
    function setContribs(db){ localStorage.setItem("lng_contribs", JSON.stringify(db)); }
    function fmt(n){ return new Intl.NumberFormat(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}).format(n||0); }
    const FUNDS = ["savings","emergency","education","health","events","projects"];
    const FUND_LABELS = {
      savings:"Kwigomwa & Kuzigamira",
      emergency:"Inkunga yâ€™ihutirwa",
      education:"Fonds yâ€™Uburezi",
      health:"Inkunga yâ€™Ubuvuzi",
      events:"Inkunga yâ€™ibirori",
      projects:"Imishinga yâ€™iterambere"
    };

    // ===== Roles (admin?) =====
    // 1) niba users[email].role === "admin" -> admin
    // 2) cyangwa email irangirana na @lesnganyira.org -> admin (fallback yoroheje)
    const users = JSON.parse(localStorage.getItem("lng_users")||"{}");
    const me = users[email] || {};
    const isAdmin = (me.role === "admin") || /@lesnganyira\.org$/i.test(email);

    // ===== Filters =====
    function getRowsAllMine(){
      const db = getContribs();
      return (db[email]||[]);
    }
    function getRowsPaidApproved(){
      return getRowsAllMine().filter(r => (r.status||"").toLowerCase()==="paid" && r.approved===true);
    }
    function getRowsPending(){
      return getRowsAllMine().filter(r => (r.status||"").toLowerCase()==="paid" && r.approved!==true);
    }

    // ===== Render KPIs (paid+approved) =====
    function renderKPIs(){
      const rows = getRowsPaidApproved();
      const total = rows.reduce((s,r)=> s + Number(r.amountCAD||0), 0);
      document.getElementById("kpiTotal").textContent = fmt(total);
      document.getElementById("kpiCount").textContent = rows.length;

      const agg = {};
      rows.forEach(r=>{
        const k = r.fund || "savings";
        agg[k] = (agg[k]||0) + Number(r.amountCAD||0);
      });
      let top = "â€”", topVal = -1;
      Object.keys(agg).forEach(k=>{ if (agg[k]>topVal){ top=k; topVal=agg[k]; }});
      document.getElementById("kpiTopFund").textContent = top==="â€”" ? "â€”" : (FUND_LABELS[top]||top);
    }

    // ===== Per-fund (paid+approved) =====
    function renderFundTotals(){
      const rows = getRowsPaidApproved();
      const totals = FUNDS.reduce((o,k)=> (o[k]=0,o),{});
      rows.forEach(r=>{ totals[r.fund||"savings"] += Number(r.amountCAD||0); });
      const box = document.getElementById("fundTotals");
      box.innerHTML = FUNDS.map(k=>`
        <div class="card kpi">
          <div class="lbl">${FUND_LABELS[k]}</div>
          <div class="val">${fmt(totals[k])} CAD</div>
        </div>
      `).join("");
    }

    // ===== History (paid+approved) =====
    function renderHistory(){
      const rows = getRowsPaidApproved().slice().reverse();
      const box = document.getElementById("historyBox");
      if (!rows.length){ box.textContent = "Nta byemejwe biragaragara."; return; }
      let html = '<div style="overflow:auto;"><table class="simple">';
      html += `<thead><tr>
        <th>Itariki</th>
        <th>Fund</th>
        <th>Byatangirijweho</th>
        <th>Mu CAD</th>
        <th>Ibisobanuro</th>
        <th>Ref</th>
      </tr></thead><tbody>`;
      rows.forEach(r=>{
        const d = new Date(r.at||Date.now()).toLocaleString();
        html += `<tr>
          <td>${d}</td>
          <td>${FUND_LABELS[r.fund||"savings"]||r.fund}</td>
          <td>${fmt(r.amountOriginal)} ${r.currency||""}</td>
          <td>${fmt(r.amountCAD)} CAD</td>
          <td>${(r.note||"")}</td>
          <td>${r.tx_ref||""}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      box.innerHTML = html;
    }

    // ===== Admin Approvals (paid but not approved) =====
    function approveTx(tx_ref){
      const db = getContribs();
      const arr = db[email] || [];
      const rec = arr.find(r=> r.tx_ref===tx_ref);
      if (rec){ rec.approved = true; setContribs(db); renderAll(); }
    }
    function rejectTx(tx_ref){
      if (!confirm("Uremeza kwanga (gusiba) iyi nyandiko?")) return;
      const db = getContribs();
      db[email] = (db[email]||[]).filter(r=> r.tx_ref!==tx_ref);
      setContribs(db);
      renderAll();
    }
    function renderPending(){
      const box = document.getElementById("pendingBox");
      const rows = getRowsPending().slice().reverse();
      if (!isAdmin){
        document.getElementById("adminBox").style.display = "none";
        return;
      }
      document.getElementById("adminBox").style.display = "block";
      if (!rows.length){ box.textContent = "Nta byategereje kwemezwa."; return; }
      let html = '<div style="overflow:auto;"><table class="simple">';
      html += `<thead><tr>
        <th>Itariki</th>
        <th>Fund</th>
        <th>Byatangirijweho</th>
        <th>Mu CAD</th>
        <th>Ref</th>
        <th>Actions</th>
      </tr></thead><tbody>`;
      rows.forEach(r=>{
        const d = new Date(r.at||Date.now()).toLocaleString();
        html += `<tr>
          <td>${d}</td>
          <td>${FUND_LABELS[r.fund||"savings"]||r.fund}</td>
          <td>${fmt(r.amountOriginal)} ${r.currency||""}</td>
          <td>${fmt(r.amountCAD)} CAD</td>
          <td>${r.tx_ref||""}</td>
          <td>
            <button class="btn" onclick="approveTx('${r.tx_ref||''}')">Approve</button>
            <button class="btn ghost danger" onclick="rejectTx('${r.tx_ref||''}')">Reject</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      box.innerHTML = html;
    }

    // ===== Export CSV (approved only) =====
    document.getElementById("btnExport").addEventListener("click", ()=>{
      const rows = getRowsPaidApproved();
      if (!rows.length){ alert("Nta byemejwe byo kohereza."); return; }
      const header = ["date","fund","amountOriginal","currency","amountCAD","note","tx_ref"];
      const csv = [header.join(",")].concat(rows.map(r=>{
        const d = new Date(r.at||Date.now()).toISOString();
        return [d, r.fund||"", r.amountOriginal||0, r.currency||"", r.amountCAD||0, (r.note||"").replace(/,/g,";"), r.tx_ref||""].join(",");
      })).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "les-nganyira_paid_approved_contributions.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    function renderAll(){
      renderKPIs(); renderFundTotals(); renderHistory(); renderPending();
    }

    // First paint
    renderAll();
  </script>
</body>
</html>
